<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - BCA Store</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {font-family:'Fira Code', monospace; margin:0; padding:0; background:#0f111a; color:#cfd8dc;}
header {background:#1f2233; padding:20px; text-align:center; color:#00ffcc;}
h1,h2,h3{margin:0;}
.container{padding:20px;}
table{width:100%; border-collapse:collapse; margin:15px 0;}
th,td{border:1px solid #22253b; padding:10px; text-align:left;}
th{background:#22253b;color:#00ffcc;}
tr:nth-child(even){background:#1a1c2b;}
.btn{background:#00ffcc;color:#0f111a;padding:6px 12px;border:none;border-radius:5px;cursor:pointer;margin:2px;transition:0.2s;}
.btn:hover{background:#00d6b2;}
select{padding:5px;border-radius:6px;border:none;background:#22253b;color:#cfd8dc;}
input[type=password]{padding:10px;border-radius:6px;border:none;margin-top:15px;width:100%;max-width:250px;}
#loginSection{text-align:center;margin-top:100px;}
.stats{margin-top:10px;font-weight:bold;}
.sectionTitle{margin-top:25px; margin-bottom:10px; color:#00ffcc; font-size:1.2em;}
</style>
</head>
<body>

<div id="loginSection">
  <h1>Admin Login</h1>
  <input type="password" id="adminPass" placeholder="Enter Password">
  <button class="btn" onclick="checkLogin()">Login</button>
</div>

<div id="adminPanel" style="display:none;">
  <header>
    <h1>Admin Panel - BCA Store</h1>
    <p class="stats" id="stats">Loading stats...</p>
  </header>

  <div class="container">
    <h2 class="sectionTitle">Orders</h2>
    <table id="ordersTable">
      <thead>
        <tr><th>Order ID</th><th>Product</th><th>Name</th><th>Email</th><th>Mobile</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 class="sectionTitle">Feedbacks</h2>
    <table id="feedbackTable">
      <thead>
        <tr><th>Order ID</th><th>Product</th><th>Feedback</th><th>Date</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="btn" onclick="exportPDF()">Export All to PDF</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getFirestore, collection, doc, updateDoc, deleteDoc, onSnapshot 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBBV_jXIewP2OfcqYxtj2regQCicduc2fY",
  authDomain: "ount-32a16.firebaseapp.com",
  projectId: "ount-32a16",
  storageBucket: "ount-32a16.firebasestorage.app",
  messagingSenderId: "865150215832",
  appId: "1:865150215832:web:d6ab92c351584c71aa12ed"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const adminPassword = "Harsh@123";

// -------- Login --------
window.checkLogin = function(){
  const pass = document.getElementById("adminPass").value;
  if(pass === adminPassword){
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadAdminData();
  }else{
    alert("Incorrect Password!");
  }
}

// -------- Load Admin Data --------
async function loadAdminData(){
  const buyCountRef = doc(db,"storeInfo","buyCount");
  const visitorRef = doc(db,"storeInfo","visitorCount");

  // Live stats
  onSnapshot(buyCountRef, snap=>updateStats());
  onSnapshot(visitorRef, snap=>updateStats());

  async function updateStats(){
    const bSnap = await buyCountRef.get();
    const vSnap = await visitorRef.get();
    document.getElementById("stats").textContent = `Total Buys: ${bSnap.data()?.total||0} | Visitors: ${vSnap.data()?.total||0}`;
  }

  // -------- Orders Table --------
  const ordersCol = collection(db,"orders");
  onSnapshot(ordersCol, snap=>{
    const tbody = document.querySelector("#ordersTable tbody");
    tbody.innerHTML = "";
    snap.forEach(d=>{
      const data = d.data();
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data.orderId}</td>
        <td>${data.product}</td>
        <td>${data.name}</td>
        <td>${data.email}</td>
        <td>${data.mobile}</td>
        <td>
          <select id="status_${d.id}">
            <option value="Order Placed"${data.status==="Order Placed"?" selected":""}>Order Placed</option>
            <option value="Order Confirmed"${data.status==="Order Confirmed"?" selected":""}>Order Confirmed</option>
            <option value="Order Processing"${data.status==="Order Processing"?" selected":""}>Order Processing</option>
            <option value="Delivered"${data.status==="Delivered"?" selected":""}>Delivered</option>
          </select>
        </td>
        <td>
          <button class="btn" onclick="updateStatus('${d.id}')">Update</button>
          <button class="btn" onclick="deleteOrder('${d.id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  });

  // -------- Feedback Table --------
  const feedbackCol = collection(db,"feedbacks");
  onSnapshot(feedbackCol, snap=>{
    const tbody = document.querySelector("#feedbackTable tbody");
    tbody.innerHTML = "";
    snap.forEach(d=>{
      const data = d.data();
      const date = data.time?.toDate()?.toLocaleString()||"";
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data.orderId}</td>
        <td>${data.product}</td>
        <td>${data.feedback}</td>
        <td>${date}</td>
        <td>
          <button class="btn" onclick="deleteFeedback('${d.id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  });
}

// -------- Admin Actions --------
window.updateStatus = async function(id){
  const sel = document.getElementById("status_"+id);
  await updateDoc(doc(db,"orders",id),{status: sel.value});
  alert("Order Status Updated! (Live on user site)");
}

window.deleteOrder = async function(id){
  if(confirm("Delete this order?")) await deleteDoc(doc(db,"orders",id));
}

window.deleteFeedback = async function(id){
  if(confirm("Delete this feedback?")) await deleteDoc(doc(db,"feedbacks",id));
}

// -------- Export PDF --------
window.exportPDF = function(){
  let html="<h2>BCA Store Orders & Feedbacks</h2>";
  html+="<h3>Orders</h3>"+document.getElementById("ordersTable").outerHTML;
  html+="<h3>Feedbacks</h3>"+document.getElementById("feedbackTable").outerHTML;
  const w=window.open("","Print");
  w.document.write(html);
  w.document.close();
  w.print();
}
</script>
</body>
</html>
